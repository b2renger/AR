<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
    <!--
  <script defer>
    let audio = new Audio('./assets/sounds.mp3'); // load the sound as an html5 element (without webaudio api)
    AFRAME.registerComponent('playsound', {
      init: function (data) {

        document.addEventListener('click', function (evt) {
          audio.play(); // play the sound
        });
      }
    });
  </script>-->

    <script defer>
      // let userConsent = false;

      // document.querySelector("click", () => {
      //   userConsent = true
      // });

      // https://github.com/nikolaiwarner/aframe-chromakey-material
      AFRAME.registerShader("chromakey", {
        schema: {
          src: { type: "map" },
          color: {
            default: { x: 0.0, y: 1.0, z: 0.0 },
            type: "vec3",
            is: "uniform",
          },
          chroma: { type: "bool", is: "uniform" },
          transparent: { default: true, is: "uniform" },
        },

        init: function (data) {
          const videoEl = data.src;
          document.addEventListener("click", () => {
            videoEl.play();
            const entity = document.querySelector("[sound]");
            // console.log(entity)
            // console.log(document.querySelector("#debug-marker"))
            entity.components.sound.playSound();
          });

          var videoTexture = new THREE.VideoTexture(data.src);
          videoTexture.minFilter = THREE.LinearFilter;
          this.material = new THREE.ShaderMaterial({
            uniforms: {
              chroma: {
                type: "b",
                value: data.chroma,
              },
              color: {
                type: "c",
                value: data.color,
              },
              myTexture: {
                type: "t",
                value: videoTexture,
              },
            },
            vertexShader: `
            varying vec2 vUv;

            void main(void)
            {
              vUv = uv;
              vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
              gl_Position = projectionMatrix * mvPosition;
            }
          `,
            fragmentShader: `
              uniform sampler2D myTexture;
              uniform vec3 color;
              uniform bool chroma;
              varying vec2 vUv;

              void main(void)
              {
                vec3 tColor = texture2D( myTexture, vUv ).rgb;
                float a;
                if(chroma == true){
                   a = (length(tColor - color) - 0.5) * 7.0;
                }
                else {
                  a = 1.0;
                }

                gl_FragColor = vec4(tColor, a);
              }
            `,
          });
        },

        update: function (data) {
          this.material.color = data.color;
          this.material.src = data.src;
          this.material.transparent = data.transparent;
        },
      });

      AFRAME.registerComponent("vidhandler", {
        trackedElements: null,

        init: function () {
          this.trackedElements = document.querySelectorAll(
            "a-marker[vidhandler]"
          );
          console.log(this.trackedElements);
        },
        tick: function () {
          // if(!userConsent){
          //   return;
          // }

          this.trackedElements.forEach((marker) => {
            if (marker.object3D.visible) {
              const vid = document.querySelector(
                marker.attributes.vidreference.value
              );
             // const sound = document.querySelector(
             //   marker.attributes.audioReference.value
             // );

             // console.log(vid);
              //console.log(sound);

              if (vid.paused) {
                vid.play();
              }

              //if (sound.paused) {
              //  sound.play();
             // }
            } else {
              const vid = document.querySelector(
                marker.attributes.vidreference.value
              );
              //const sound = document.querySelector(
              //  marker.attributes.audioReference.value
              //);

              if (!vid.paused) {
                vid.pause();
                vid.currentTime = 0;
              }

              //if (!sound.paused) {
              //  sound.pause();
               // sound.currentTime = 0;
             // }
            }
          });
        },
      });
    </script>
  </head>

  <body style="margin: 0px; overflow: hidden">
    <a-scene
      embedded
      arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best ; changeMatrixMode: modelViewMatrix;"
      vr-mode-ui="enabled: false"
      renderer="sortObjects: true; antialias: true; colorManagement: true; physicallyCorrectLights; logarithmicDepthBuffer: true;"
      smooth=" true"
      smoothCount="5"
      smoothTolerance=".05"
      smoothThreshold="5"
      sourceWidth="800"
      sourceHeight="600"
      displayWidth="1280"
      displayHeight="720"
    >
      <a-assets>
        
        <video
          id="vid1"
          src="assets/artwork2.mp4"
          autoplay="true"
          loop="true"
          preload="auto"
          controls="true"
          muted="true"
          playsinline=""
          webkit-playsinline=""
        ></video>

       

        <video
          id="vid2"
          src="assets/artwork3.mp4"
          autoplay="true"
          loop="true"
          preload="auto"
          controls="true"
          muted="true"
          playsinline=""
          webkit-playsinline=""
        ></video>


        <video
          id="vid3"
          src="assets/artwork4.mp4"
          autoplay="true"
          loop="true"
          preload="auto"
          controls="true"
          muted="true"
          playsinline=""
          webkit-playsinline=""
        ></video>

       

        <video
          id="vid4"
          src="assets/artwork5.mp4"
          autoplay="true"
          loop="true"
          preload="auto"
          controls="true"
          muted="true"
          playsinline=""
          webkit-playsinline=""
        ></video>

       

       
        
      </a-assets>

  

      <a-marker 
        vidhandler
        vidreference="#vid1"
       
        type="barcode" value="1">
        
        <a-entity
          material="shader: chromakey; src: #vid1; chroma:false; color: 0. 0. 0."
          geometry="primitive: plane; width:  1; height:  1"
          position="0  0  0"
          rotation="270  0  0"
          side="double"
        >
        </a-entity>
      </a-marker>

      <a-marker 
          vidhandler
          vidreference="#vid2"
       
        type="barcode" value="2">
        
        <a-entity
          material="shader: chromakey; src: #vid2; chroma:false; color: 0. 0. 0."
          geometry="primitive: plane; width:  1; height:  1"
          position="0  0  0"
          rotation="270  0  0"
          side="double"
        >
        </a-entity>
      </a-marker>

      <a-marker 
        vidhandler
        vidreference="#vid3"
       
        type="barcode" value="3">
        <a-entity
          material="shader: chromakey; src: #vid3; chroma:false; color: 0. 0. 0."
          geometry="primitive: plane; width:  1; height:  1"
          position="0  0  0"
          rotation="270  0  0"
          side="double"
        >
        </a-entity>
      </a-marker>

      <a-marker 
        vidhandler
        vidreference="#vid4"
       
        type="barcode" value="4">
        <a-entity
          material="shader: chromakey; src: #vid4; chroma:false; color: 0. 0. 0."
          geometry="primitive: plane; width:  1; height:  1"
          position="0  0  0"
          rotation="270  0  0"
          side="double"
        >
        </a-entity>
      </a-marker>



      <a-camera position="0 0 0" look-controls="enabled: false">
        
      </a-camera>
    </a-scene>
  </body>
</html>
